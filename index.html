<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Party Animal Game</title>
  <meta name="description" content="A fun synced party game for friends!">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-database-compat.js"></script>

  <style>
    /* Custom Tailwind utilities */
    .glass-card {
      @apply bg-white bg-opacity-20 backdrop-blur-lg border border-white border-opacity-30 shadow-xl rounded-3xl;
    }
    .btn-bouncy {
      @apply active:scale-95 transition-transform duration-150 ease-in-out font-bold uppercase tracking-wider;
    }
    .animate-float {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
      100% { transform: translateY(0px); }
    }
    .animate-pop {
      animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .bg-pattern {
      background-color: #FFE53B;
      background-image: linear-gradient(147deg, #FFE53B 0%, #FF2525 74%);
    }
  </style>
</head>
<body class="bg-pattern min-h-screen text-white overflow-hidden">

<div id="root"></div>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyD-NNdZSUbWzL6qOBX47paNVbyoPQBQwWo",
    authDomain: "party-animal-game-3a4d9.firebaseapp.com",
    databaseURL: "https://party-animal-game-3a4d9-default-rtdb.firebaseio.com",
    projectId: "party-animal-game-3a4d9",
    storageBucket: "party-animal-game-3a4d9.appspot.com",
    messagingSenderId: "245560929951",
    appId: "1:245560929951:web:36fb18c763727a2ce2bcaa"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // --- DB functions ---
  const DB = {
    async getCharacters() {
      const snapshot = await database.ref('characters').get();
      if (snapshot.exists()) {
        return Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
      }
      return [];
    },
    async getGameState() {
      const snapshot = await database.ref('game_state').get();
      return snapshot.exists() ? snapshot.val() : null;
    },
    async updateGameState(characterId) {
      await database.ref('game_state').set({
        current_character_id: characterId,
        turn_start_time: Date.now()
      });
    }
  };

  // --- Confetti ---
  function fireConfetti() {
    const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FFFFFF', '#FF006E'];
    for (let i = 0; i < 100; i++) {
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = '-10px';
      el.style.width = Math.random() * 10 + 5 + 'px';
      el.style.height = Math.random() * 10 + 5 + 'px';
      el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      el.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      el.style.transition = `top ${Math.random() * 3 + 2}s linear, transform ${Math.random() * 3 + 2}s ease, opacity ${Math.random() * 3 + 2}s ease`;
      document.body.appendChild(el);
      requestAnimationFrame(() => {
        el.style.top = '110vh';
        el.style.transform = `rotate(${Math.random()*360}deg) translateX(${Math.random()*100-50}px)`;
        el.style.opacity = '0';
      });
      setTimeout(() => el.remove(), 5000);
    }
  }

  // --- Components ---
  const { useState, useEffect } = React;

  function GameCard({ character, isLoading }) {
    if (!character) return null;
    return (
      <div className="w-full max-w-sm mx-auto p-4 z-10 relative">
        <div className={`glass-card p-6 flex flex-col items-center justify-center animate-float transition-all duration-500 ${isLoading ? 'scale-95 opacity-80' : 'scale-100 opacity-100'}`}>
          <div className="relative w-64 h-64 mb-6 rounded-full border-4 border-white shadow-lg overflow-hidden bg-gray-200">
            {isLoading ? <div className="w-full h-full flex items-center justify-center">Loading...</div> :
              <img src={character.image_url} alt={character.name} className="w-full h-full object-cover animate-pop" />}
          </div>
          <h2 className="text-3xl font-black text-white drop-shadow-md text-center mb-2">
            {isLoading ? "Picking..." : character.name}
          </h2>
          <div className="flex items-center space-x-2 text-white/90">
            <span className="font-semibold uppercase tracking-widest text-sm">Current Player</span>
          </div>
        </div>
      </div>
    );
  }

  function Controls({ onNext, isUpdating }) {
    return (
      <div className="fixed bottom-0 left-0 w-full p-6 pb-10 flex flex-col items-center z-20 bg-gradient-to-t from-black/20 to-transparent">
        <button
          onClick={onNext}
          disabled={isUpdating}
          className="btn-bouncy w-full max-w-xs bg-white text-[var(--primary-color)] text-xl py-4 rounded-full shadow-xl border-b-4 border-gray-200 hover:bg-gray-50 disabled:opacity-70 disabled:cursor-not-allowed"
        >
          {isUpdating ? "Spinning..." : "Next Player"}
        </button>
      </div>
    );
  }

  function Sparkles() {
    const [sparkles, setSparkles] = useState([]);
    useEffect(() => {
      setSparkles(Array.from({ length: 20 }).map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        top: Math.random() * 100,
        size: Math.random() * 20 + 10,
        delay: Math.random() * 5,
        duration: Math.random() * 3 + 2
      })));
    }, []);
    return (
      <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        {sparkles.map(s => (
          <div key={s.id} className="absolute text-white opacity-40 animate-pulse"
               style={{ left: `${s.left}%`, top: `${s.top}%`, fontSize: `${s.size}px`, animationDelay: `${s.delay}s`, animationDuration: `${s.duration}s` }}>
          âœ¦
          </div>
        ))}
      </div>
    );
  }

  function App() {
    const [characters, setCharacters] = useState([]);
    const [currentCharacter, setCurrentCharacter] = useState(null);
    const [isUpdating, setIsUpdating] = useState(false);

    // Load characters & game state
    useEffect(() => {
      async function load() {
        const chars = await DB.getCharacters();
        setCharacters(chars);
        const state = await DB.getGameState();
        if (state && chars.length > 0) {
          const char = chars.find(c => c.id === state.current_character_id);
          setCurrentCharacter(char);
        }
      }
      load();

      // Listen to changes
      database.ref('game_state').on('value', snapshot => {
        const state = snapshot.val();
        if (state) {
          const char = characters.find(c => c.id === state.current_character_id);
          if (char) setCurrentCharacter(char);
        }
      });
    }, [characters]);

    const handleNextPlayer = async () => {
      if (isUpdating || characters.length === 0) return;
      setIsUpdating(true);

      let nextChar;
      if (characters.length > 1 && currentCharacter) {
        const otherChars = characters.filter(c => c.id !== currentCharacter.id);
        nextChar = otherChars[Math.floor(Math.random() * otherChars.length)];
      } else {
        nextChar = characters[Math.floor(Math.random() * characters.length)];
      }

      await DB.updateGameState(nextChar.id);
      fireConfetti();
      setIsUpdating(false);
    };

    if (!currentCharacter) return <div className="min-h-screen flex items-center justify-center text-white">Loading...</div>;

    return (
      <div className="min-h-screen relative flex flex-col items-center justify-center p-4">
        <Sparkles />
        <GameCard character={currentCharacter} isLoading={isUpdating} />
        <Controls onNext={handleNextPlayer} isUpdating={isUpdating} />
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
